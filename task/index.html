<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ふたりタスクボード</title>
  <style>
    :root{
      --bg:#0f0a1f;
      --bg2:#1a1235;
      --panel:#1f1642;
      --card:#2a1c58;
      --text:#f4f0ff;
      --muted:#b8a8e8;
      --line:#4f3f85;
      --accent:#b084ff;
      --accent2:#8f5cff;
      --ok:#76e1b2;
      --warn:#ffd166;
      --danger:#ff7a9e;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(120% 120% at 10% 0%, #2b1a5a 0%, var(--bg) 50%) fixed;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:20px}
    h1{margin:0 0 8px; font-size:clamp(24px,4vw,34px)}
    .sub{color:var(--muted); margin:0 0 18px}
    .grid{display:grid; gap:14px}
    .panel{
      background:linear-gradient(170deg, rgba(176,132,255,.12), rgba(176,132,255,.04));
      border:1px solid var(--line); border-radius:16px; padding:14px;
      box-shadow:var(--shadow);
    }
    .toolbar{display:grid; grid-template-columns:1.1fr 1fr 1fr 1fr auto; gap:10px; align-items:end}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:5px}
    input, select, textarea, button{
      width:100%; border-radius:10px; border:1px solid #5d4b9b;
      background:#1c133a; color:var(--text); padding:10px;
      font:inherit;
    }
    textarea{min-height:76px; resize:vertical}
    .btn{background:linear-gradient(145deg,var(--accent),var(--accent2)); border:none; font-weight:700; cursor:pointer}
    .btnGhost{background:#271c53}
    .topline{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{padding:6px 10px; border-radius:999px; background:#2f2264; border:1px solid #5a4890; font-size:12px}
    .layout{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
    .col{background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:12px; padding:10px}
    .col h3{margin:4px 0 10px; font-size:15px}
    .task{background:var(--card); border:1px solid #5e4ca1; border-radius:12px; padding:10px; margin:10px 0}
    .task h4{margin:0 0 8px; font-size:15px}
    .meta{font-size:12px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap}
    .actions{display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:8px; margin-top:10px}
    .actions button{padding:8px}
    .empty{color:var(--muted); font-size:13px}
    .hint{font-size:12px; color:var(--muted)}
    .danger{background:#4a1630; border-color:#804160}
    .ok{color:var(--ok)}
    @media (max-width:920px){
      .toolbar{grid-template-columns:1fr 1fr}
      .layout{grid-template-columns:1fr}
      .actions{grid-template-columns:1fr 1fr}
    }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>ふたりタスクボード</h1>
    <p class="sub">彼女と2人で使う、日常タスク共有管理。ローカル保存・簡単操作・見やすい紫UI。</p>

    <section class="panel grid" aria-label="コントロール">
      <div class="topline">
        <div class="chips" id="stats"></div>
        <div style="display:flex; gap:8px;">
          <button class="btnGhost" id="exportBtn" type="button">バックアップJSON出力</button>
          <label class="btnGhost" style="display:inline-flex; align-items:center; padding:10px; border-radius:10px; cursor:pointer; border:1px solid #5d4b9b;">JSON読込<input type="file" id="importFile" accept="application/json" style="display:none"></label>
        </div>
      </div>

      <form id="taskForm" class="toolbar" autocomplete="off">
        <div>
          <label for="title">タスク名</label>
          <input id="title" required maxlength="60" placeholder="例: ゴミ出し" />
        </div>
        <div>
          <label for="assignee">担当</label>
          <select id="assignee">
            <option value="you">あなた</option>
            <option value="partner">彼女</option>
            <option value="both">ふたり</option>
          </select>
        </div>
        <div>
          <label for="priority">優先度</label>
          <select id="priority">
            <option value="low">低</option>
            <option value="mid" selected>中</option>
            <option value="high">高</option>
          </select>
        </div>
        <div>
          <label for="due">期限</label>
          <input id="due" type="date" />
        </div>
        <button class="btn" type="submit">追加</button>
      </form>

      <div>
        <label for="memo">メモ</label>
        <textarea id="memo" maxlength="240" placeholder="買う物、補足など"></textarea>
      </div>

      <div class="toolbar" style="grid-template-columns:1fr 1fr 1fr auto auto;">
        <div>
          <label for="search">検索</label>
          <input id="search" placeholder="タスク名/メモ" />
        </div>
        <div>
          <label for="fAssignee">担当フィルタ</label>
          <select id="fAssignee">
            <option value="all">全員</option>
            <option value="you">あなた</option>
            <option value="partner">彼女</option>
            <option value="both">ふたり</option>
          </select>
        </div>
        <div>
          <label for="fPriority">優先度フィルタ</label>
          <select id="fPriority">
            <option value="all">すべて</option>
            <option value="high">高</option>
            <option value="mid">中</option>
            <option value="low">低</option>
          </select>
        </div>
        <button class="btnGhost" id="clearDoneBtn" type="button">完了を整理</button>
        <button class="danger" id="resetBtn" type="button">全削除</button>
      </div>
      <p class="hint">ベストプラクティス: 入力検証・状態一元管理・ローカル永続化・JSONバックアップ対応。</p>
    </section>

    <section class="layout" aria-label="タスクカンバン">
      <div class="col">
        <h3>Todo</h3>
        <div id="todo"></div>
      </div>
      <div class="col">
        <h3>Doing</h3>
        <div id="doing"></div>
      </div>
      <div class="col">
        <h3>Done</h3>
        <div id="done"></div>
      </div>
    </section>
  </main>

<script>
(() => {
  'use strict';

  const STORAGE_KEY = 'couple-task-board.v1';
  const MAX_TASKS = 300;

  const el = {
    form: document.getElementById('taskForm'),
    title: document.getElementById('title'),
    memo: document.getElementById('memo'),
    assignee: document.getElementById('assignee'),
    priority: document.getElementById('priority'),
    due: document.getElementById('due'),
    search: document.getElementById('search'),
    fAssignee: document.getElementById('fAssignee'),
    fPriority: document.getElementById('fPriority'),
    clearDoneBtn: document.getElementById('clearDoneBtn'),
    resetBtn: document.getElementById('resetBtn'),
    exportBtn: document.getElementById('exportBtn'),
    importFile: document.getElementById('importFile'),
    stats: document.getElementById('stats'),
    todo: document.getElementById('todo'),
    doing: document.getElementById('doing'),
    done: document.getElementById('done'),
  };

  const app = {
    tasks: [],
    filters: { search:'', assignee:'all', priority:'all' }
  };

  const map = {
    assignee: { you:'あなた', partner:'彼女', both:'ふたり' },
    priority: { low:'低', mid:'中', high:'高' },
    status: { todo:'Todo', doing:'Doing', done:'Done' },
  };

  function uid() {
    return `${Date.now().toString(36)}${Math.random().toString(36).slice(2,8)}`;
  }

  function sanitize(str) {
    return String(str || '').trim();
  }

  function validateTask(raw) {
    const title = sanitize(raw.title);
    if (!title) throw new Error('タスク名は必須です');
    if (title.length > 60) throw new Error('タスク名は60文字以内です');

    const memo = sanitize(raw.memo);
    if (memo.length > 240) throw new Error('メモは240文字以内です');

    if (!['you','partner','both'].includes(raw.assignee)) throw new Error('担当が不正です');
    if (!['low','mid','high'].includes(raw.priority)) throw new Error('優先度が不正です');
    if (!['todo','doing','done'].includes(raw.status)) throw new Error('状態が不正です');

    let due = raw.due || '';
    if (due && !/^\d{4}-\d{2}-\d{2}$/.test(due)) throw new Error('期限の形式が不正です');

    return {
      id: raw.id || uid(),
      title, memo,
      assignee: raw.assignee,
      priority: raw.priority,
      status: raw.status,
      due,
      createdAt: raw.createdAt || new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    };
  }

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ version:1, tasks:app.tasks }));
  }

  function load() {
    try {
      const parsed = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      if (!Array.isArray(parsed.tasks)) return;
      app.tasks = parsed.tasks.map(t => validateTask(t)).slice(0, MAX_TASKS);
    } catch (e) {
      console.warn('load failed', e);
      app.tasks = [];
    }
  }

  function addTask(data) {
    if (app.tasks.length >= MAX_TASKS) throw new Error('タスク上限に達しました');
    app.tasks.unshift(validateTask({ ...data, status:'todo' }));
    save();
    render();
  }

  function updateTask(id, patch) {
    const i = app.tasks.findIndex(t => t.id === id);
    if (i < 0) return;
    app.tasks[i] = validateTask({ ...app.tasks[i], ...patch, id });
    save(); render();
  }

  function removeTask(id) {
    app.tasks = app.tasks.filter(t => t.id !== id);
    save(); render();
  }

  function clearDone() {
    app.tasks = app.tasks.filter(t => t.status !== 'done');
    save(); render();
  }

  function resetAll() {
    if (!confirm('本当に全タスクを削除しますか？')) return;
    app.tasks = [];
    save(); render();
  }

  function passesFilter(t) {
    const s = app.filters.search.toLowerCase();
    const hitText = !s || t.title.toLowerCase().includes(s) || t.memo.toLowerCase().includes(s);
    const hitAssignee = app.filters.assignee === 'all' || app.filters.assignee === t.assignee;
    const hitPriority = app.filters.priority === 'all' || app.filters.priority === t.priority;
    return hitText && hitAssignee && hitPriority;
  }

  function urgencyChip(due) {
    if (!due) return '<span class="chip">期限なし</span>';
    const today = new Date();
    today.setHours(0,0,0,0);
    const dd = new Date(due + 'T00:00:00');
    const diff = Math.round((dd - today) / 86400000);
    if (diff < 0) return '<span class="chip" style="color:#ffb3c6">期限超過</span>';
    if (diff === 0) return '<span class="chip" style="color:#ffd166">今日まで</span>';
    return `<span class="chip">あと${diff}日</span>`;
  }

  function statusNext(st) {
    if (st === 'todo') return 'doing';
    if (st === 'doing') return 'done';
    return 'todo';
  }

  function card(t) {
    return `<article class="task" data-id="${t.id}">
      <h4>${escapeHtml(t.title)}</h4>
      ${t.memo ? `<p class="hint">${escapeHtml(t.memo)}</p>` : ''}
      <div class="meta">
        <span class="chip">担当: ${map.assignee[t.assignee]}</span>
        <span class="chip">優先: ${map.priority[t.priority]}</span>
        ${urgencyChip(t.due)}
      </div>
      <div class="actions">
        <button type="button" data-action="next">次へ</button>
        <button type="button" data-action="back">戻す</button>
        <button type="button" data-action="toggle">担当切替</button>
        <button type="button" data-action="delete" class="danger">削除</button>
      </div>
    </article>`;
  }

  function escapeHtml(s) {
    return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  function renderStats(filtered) {
    const counts = {
      total: filtered.length,
      todo: filtered.filter(t => t.status === 'todo').length,
      doing: filtered.filter(t => t.status === 'doing').length,
      done: filtered.filter(t => t.status === 'done').length,
    };
    el.stats.innerHTML = `
      <span class="chip">合計 ${counts.total}</span>
      <span class="chip">Todo ${counts.todo}</span>
      <span class="chip">Doing ${counts.doing}</span>
      <span class="chip ok">Done ${counts.done}</span>`;
  }

  function render() {
    const filtered = app.tasks.filter(passesFilter);
    renderStats(filtered);

    for (const k of ['todo','doing','done']) {
      const col = el[k];
      const list = filtered
        .filter(t => t.status === k)
        .sort((a,b) => b.priority.localeCompare(a.priority) || (a.due || '9999').localeCompare(b.due || '9999'));
      col.innerHTML = list.length ? list.map(card).join('') : '<p class="empty">タスクなし</p>';
    }
  }

  function exportJson() {
    const data = JSON.stringify({ version:1, exportedAt:new Date().toISOString(), tasks:app.tasks }, null, 2);
    const blob = new Blob([data], { type:'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `task-backup-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
  }

  function importJson(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parsed = JSON.parse(String(reader.result || '{}'));
        if (!Array.isArray(parsed.tasks)) throw new Error('tasks 配列がありません');
        app.tasks = parsed.tasks.map(t => validateTask(t)).slice(0, MAX_TASKS);
        save(); render();
      } catch (e) {
        alert(`読込失敗: ${e.message}`);
      }
    };
    reader.readAsText(file, 'utf-8');
  }

  el.form.addEventListener('submit', (e) => {
    e.preventDefault();
    try {
      addTask({
        title: el.title.value,
        memo: el.memo.value,
        assignee: el.assignee.value,
        priority: el.priority.value,
        due: el.due.value,
      });
      el.form.reset();
      el.priority.value = 'mid';
      el.title.focus();
    } catch (err) {
      alert(err.message);
    }
  });

  [el.search, el.fAssignee, el.fPriority].forEach(ctrl => {
    ctrl.addEventListener('input', () => {
      app.filters.search = el.search.value.trim();
      app.filters.assignee = el.fAssignee.value;
      app.filters.priority = el.fPriority.value;
      render();
    });
  });

  el.clearDoneBtn.addEventListener('click', clearDone);
  el.resetBtn.addEventListener('click', resetAll);
  el.exportBtn.addEventListener('click', exportJson);
  el.importFile.addEventListener('change', (e) => importJson(e.target.files?.[0]));

  document.body.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;
    const card = btn.closest('.task');
    if (!card) return;
    const id = card.dataset.id;
    const t = app.tasks.find(x => x.id === id);
    if (!t) return;

    const act = btn.dataset.action;
    if (act === 'next') updateTask(id, { status: statusNext(t.status) });
    if (act === 'back') updateTask(id, { status: t.status === 'done' ? 'doing' : 'todo' });
    if (act === 'toggle') {
      const next = t.assignee === 'you' ? 'partner' : t.assignee === 'partner' ? 'both' : 'you';
      updateTask(id, { assignee: next });
    }
    if (act === 'delete') removeTask(id);
  });

  load();
  render();
})();
</script>
</body>
</html>
